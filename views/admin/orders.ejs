<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Order Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .offer-list { font-size: 0.95em; color: #b91c1c; }
    .original-total { text-decoration: line-through; color: #888; font-size: 0.95em; }
    .discounted-total { color: #059669; font-weight: bold; }
  </style>
</head>
<body class="bg-gray-50 flex flex-col md:flex-row min-h-screen">
  <%- include('partials/sidebar') %>
  <div class="flex-1 md:ml-72 p-6 overflow-auto">
    <h1 class="text-2xl font-bold text-gray-800 mb-6">Orders Management</h1>
    <div class="bg-white rounded-2xl shadow-lg p-6 overflow-x-auto">
      <table class="min-w-full table-auto text-sm sm:text-base border-collapse">
        <thead class="bg-gray-100 sticky top-0 z-10">
          <tr>
            <th class="px-4 py-3 text-left text-gray-700 font-semibold">Order ID</th>
            <th class="px-4 py-3 text-left text-gray-700 font-semibold">Customer</th>
            <th class="px-4 py-3 text-left text-gray-700 font-semibold">Date</th>
            <th class="px-4 py-3 text-left text-gray-700 font-semibold">Status</th>
            <th class="px-4 py-3 text-left text-gray-700 font-semibold">Offer Details</th>
            <th class="px-4 py-3 text-left text-gray-700 font-semibold">Total</th>
            <th class="px-4 py-3 text-left text-gray-700 font-semibold">Action</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 text-gray-800">
          <% order.forEach(order => { 
            // Calculate discounted total for this order
            let discountedTotal = 0, originalTotal = 0;
            order.items.forEach(item => {
              originalTotal += (item.originalPrice || item.productId.price) * item.quantity;
              discountedTotal += (item.discountedPrice || item.productId.price) * item.quantity;
            });
            // Prepare offer summaries
            const offerSummaries = order.items
              .filter(item => item.discountPercentage)
              .map(item => `${item.productId.title}: ${item.discountPercentage}% OFF (${item.offerName})`);
            // Status summary
            const statuses = order.items.map(i => i.status);
            const uniqueStatuses = [...new Set(statuses)];
            let summaryStatus = uniqueStatuses.length === 1 ? uniqueStatuses[0] : 'Mixed';
          %>
          <tr class="hover:bg-gray-50 transition">
            <td class="px-4 py-3 font-medium text-gray-900 whitespace-nowrap">#<%= order.orderId %></td>
            <td class="px-4 py-3 whitespace-nowrap">
              <div class="font-semibold"><%= order.userId?.name %></div>
              <div class="text-gray-500 text-xs"><%= order.userId?.email %></div>
            </td>
            <td class="px-4 py-3 whitespace-nowrap"><%= order.createdAt.toDateString() %></td>
            <td class="px-4 py-3">
              <% if (order.paymentStatus === 'failed' && order.paymentMethod === 'razorpay') { %>
                <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                  Payment Failed
                </span>
              <% } else { %>
                <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full
                  <%= summaryStatus === 'Delivered' ? 'bg-green-100 text-green-800' : '' %>
                  <%= summaryStatus === 'Shipped' ? 'bg-blue-100 text-blue-800' : '' %>
                  <%= summaryStatus === 'Out for Delivery' ? 'bg-yellow-100 text-yellow-800' : '' %>
                  <%= summaryStatus === 'Pending' ? 'bg-yellow-300 text-yellow-800' : '' %>
                  <%= summaryStatus === 'Cancelled' ? 'bg-red-100 text-red-800' : '' %>
                  <%= summaryStatus === 'Mixed' ? 'bg-gray-200 text-gray-800' : '' %>">
                  <%= summaryStatus %>
                </span>
              <% } %>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">
              <% if (offerSummaries.length > 0) { %>
                <ul class="offer-list list-disc pl-4 mb-1">
                  <% offerSummaries.forEach(offer => { %>
                    <li><%= offer %></li>
                  <% }) %>
                </ul>
              <% } %>
              <% if (order.coupon) { %>
                <div class="mt-1 px-2 py-1 rounded bg-blue-50 border border-blue-200 text-blue-700 text-xs font-semibold inline-flex items-center gap-1">
                  <i class="fa-solid fa-ticket"></i>
                  Coupon Applied: <%= order.coupon %>
                  <% if (order.discount > 0) { %>
                    <span class="ml-1">(-₹<%= order.discount.toLocaleString('en-IN') %>)</span>
                  <% } %>
                </div>
              <% } else if (offerSummaries.length === 0) { %>
                <span class="text-gray-400">No Offers</span>
              <% } %>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">
              <% if (typeof order.grandTotal !== 'undefined') { %>
                <span class="discounted-total">₹ <%= order.grandTotal.toLocaleString('en-IN') %></span>
              <% } else { %>
                <span class="discounted-total">₹ <%= discountedTotal.toLocaleString('en-IN') %></span>
              <% } %>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">
              <a href="/admin/Userorderdetail/<%= order._id %>" 
                class="inline-flex items-center gap-2 px-3 py-1.5 border border-indigo-600 bg-white rounded-md text-sm text-indigo-700 hover:bg-indigo-600 hover:text-white transition font-medium shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12C3.75 7.5 7.5 4.5 12 4.5s8.25 3 9.75 7.5c-1.5 4.5-5.25 7.5-9.75 7.5s-8.25-3-9.75-7.5z" />
                </svg>
                View
              </a>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
      
    </div>
  </div>
  
</body>
</html>