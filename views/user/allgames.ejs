<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Game Store</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <style>
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #ffffff;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
    }

    .loading-overlay.hidden {
      opacity: 0;
      visibility: hidden;
    }

    .loading-spinner {
      width: 80px;
      height: 80px;
      position: relative;
      animation: logo-spin 3s linear infinite;
    }

    .loading-content {
      text-align: center;
    }

    .loading-logo {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      background: linear-gradient(to right, #6366f1, #ec4899);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: bold;
    }

    .loading-progress {
      width: 120px;
      height: 4px;
      background: #e5e7eb;
      border-radius: 4px;
      margin: 1rem auto;
      overflow: hidden;
    }

    .loading-progress-bar {
      width: 0%;
      height: 100%;
      background: linear-gradient(to right, #6366f1, #ec4899);
      border-radius: 4px;
      transition: width 0.3s ease-out;
      animation: progress 2s ease-out forwards;
    }

    .loading-text {
      color: #6b7280;
      font-size: 0.875rem;
    }

    @keyframes logo-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes progress {
      0% { width: 0%; }
      100% { width: 100%; }
    }

    /* Hide content while loading */
    .content-container {
      opacity: 0;
      transition: opacity 0.5s ease-out;
    }

    .content-container.loaded {
      opacity: 1;
    }
  </style>
  <script>
    function toggleDropdown(id) {
      const dropdown = document.getElementById(id);
      const arrow = document.getElementById("arrow" + id.replace("Dropdown", ""));
      dropdown.classList.toggle("hidden");
      arrow.classList.toggle("rotate-180");
    }

    function toggleMobileFilters() {
      const sidebar = document.getElementById("sidebar");
      sidebar.classList.toggle("hidden");
    }
  </script>
</head>
<body class="bg-white text-gray-900">
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-logo">üéÆ</div>
      <div class="loading-spinner">
        <div class="loading-logo">GameZone</div>
      </div>
      <div class="loading-progress">
        <div class="loading-progress-bar"></div>
      </div>
      <div class="loading-text">Loading amazing games...</div>
    </div>
  </div>

  <!-- Wrap all content in a container -->
  <div class="content-container" id="mainContent">
    <!-- Navigation -->
    <nav class="bg-white shadow-md fixed w-full top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <!-- Logo and Brand -->
          <div class="flex items-center">
            <a href="/home" class="flex items-center">
              <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-pink-600 hover:from-indigo-500 hover:to-pink-500 transition duration-300">
                üéÆ GameZone
              </h1>
            </a>
          </div>

          <!-- Desktop Navigation -->
          <div class="hidden md:flex items-center space-x-8">
            <!-- Search Bar -->
            <div class="relative">
              <input type="text" 
                     placeholder="Search games..."  id="searchInput"
                     class="w-72 px-4 py-2 rounded-full border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-200 bg-gray-50">
              <button class="absolute right-3 top-2.5 text-gray-400 hover:text-indigo-600">
                <i class="fas fa-search"></i>
              </button>
            </div>

            <!-- Navigation Links -->
            <div class="flex items-center space-x-6">
              <a href="/store" class="nav-link text-gray-600 hover:text-indigo-600 font-medium">Store</a>
              <a href="/library" class="nav-link text-gray-600 hover:text-indigo-600 font-medium">Library</a>
              <a href="/cart" class="relative group">
                <i class="fas fa-shopping-cart text-gray-600 hover:text-indigo-600 text-xl"></i>
                <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
              </a>
              
              <!-- User Profile Dropdown -->
              <div class="relative group">
                <button class="flex items-center space-x-2 text-gray-600 hover:text-indigo-600 focus:outline-none">
                  <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="Profile" class="w-8 h-8 rounded-full border-2 border-gray-200">
                  <span class="font-medium">Profile</span>
                  <i class="fas fa-chevron-down text-xs transition-transform duration-200 group-hover:rotate-180"></i>
                </button>
                <div class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg py-2 invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-all duration-200">
                  <a href="/profile" class="block px-4 py-2 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600">
                    <i class="fas fa-user mr-2"></i> My Profile
                  </a>
                  <a href="/orders" class="block px-4 py-2 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600">
                    <i class="fas fa-shopping-bag mr-2"></i> Orders
                  </a>
                  <a href="/wishlist" class="block px-4 py-2 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600">
                    <i class="fas fa-heart mr-2"></i> Wishlist
                  </a>
                  <hr class="my-2 border-gray-100">
                  <a href="/logout" class="block px-4 py-2 text-red-600 hover:bg-red-50">
                    <i class="fas fa-sign-out-alt mr-2"></i> Logout
                  </a>
                </div>
              </div>
            </div>
          </div>

          <!-- Mobile Navigation Button -->
          <div class="flex items-center md:hidden">
            <button id="mobileMenuBtn" class="text-gray-600 hover:text-indigo-600 focus:outline-none">
              <i class="fas fa-bars text-2xl"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Mobile Navigation Menu -->
      <div id="mobileMenu" class="hidden md:hidden bg-white border-t border-gray-100">
        <div class="px-4 py-3">
          <div class="relative mb-4">
            <input type="text" 
                   placeholder="Search games..." 
                   class="w-full px-4 py-2 rounded-full border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-200 bg-gray-50">
            <button class="absolute right-3 top-2.5 text-gray-400 hover:text-indigo-600">
              <i class="fas fa-search"></i>
            </button>
          </div>
          <a href="/store" class="block py-2 text-gray-600 hover:text-indigo-600 font-medium">Store</a>
          <a href="/library" class="block py-2 text-gray-600 hover:text-indigo-600 font-medium">Library</a>
          <a href="/cart" class="block py-2 text-gray-600 hover:text-indigo-600 font-medium">Cart</a>
          <a href="/profile" class="block py-2 text-gray-600 hover:text-indigo-600 font-medium">Profile</a>
          <a href="/orders" class="block py-2 text-gray-600 hover:text-indigo-600 font-medium">Orders</a>
          <a href="/wishlist" class="block py-2 text-gray-600 hover:text-indigo-600 font-medium">Wishlist</a>
          <hr class="my-2 border-gray-100">
          <a href="/logout" class="block py-2 text-red-600 hover:text-red-700 font-medium">Logout</a>
        </div>
      </div>
    </nav>

    <!-- Spacer for fixed navbar -->
    <div class="h-16"></div>

    <div class="flex flex-col sm:flex-row">

      <!-- Sidebar -->
      <aside id="sidebar" class="w-full sm:w-64 p-6 bg-gray-50 border-b sm:border-r sm:border-b-0 border-gray-200 sm:h-screen sm:sticky sm:top-0 hidden sm:block">
        <h2 class="text-xl font-bold mb-4">Filters</h2>
      
        <!-- Price -->
        <div class="mb-6">
          <h3 class="font-medium text-gray-700 mb-1">Price</h3>
          <input id="price-range" type="range" min="0" max="20000" value="20000" class="w-full">
          <p id="price-label" class="text-xs text-gray-500 mt-1">Up to ‚Çπ20,000</p>
        </div>
      
        <!-- Genre Dropdown -->
        <div class="mb-4">
          <button onclick="toggleDropdown('genre-filters')" class="flex justify-between items-center w-full font-medium text-gray-700">
            Genre
            <svg class="w-4 h-4 ml-2 transition-transform" id="arrowGenre" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>
          <div id="genre-filters" class="mt-3 pl-3 space-y-3 text-sm bg-white p-4 rounded-md shadow-sm hidden">
            <% category.forEach(category => { %>
              <div class="block">
                <input
                  type="checkbox"
                  id="genre-<%= category._id %>"
                  class="genre-checkbox form-checkbox h-4 w-4 text-indigo-600 transition duration-150 ease-in-out"
                  value="<%= category._id %>"
                >
                <label for="genre-<%= category._id %>" class="ml-2 text-gray-700"><%= category.categoryName %></label>
              </div>
            <% }) %>
          </div>
        </div>
      
        <!-- Company Dropdown -->
        <div class="mb-4">
          <button onclick="toggleDropdown('companyDropdown')" class="flex justify-between items-center w-full font-medium text-gray-700">
            Company
            <svg class="w-4 h-4 ml-2 transition-transform" id="arrowCompany" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>
          <div id="companyDropdown" class="mt-3 pl-3 space-y-3 text-sm bg-white p-4 rounded-md shadow-sm hidden">
            <% company.forEach(company => { %>
              <div class="block">
                <input
                  type="checkbox"
                  id="company-<%= company._id %>"
                  class="company-checkbox form-checkbox h-4 w-4 text-indigo-600 transition duration-150 ease-in-out"
                  value="<%= company._id %>"
                >
                <label for="company-<%= company._id %>" class="ml-2 text-gray-700"><%= company.name %></label>
              </div>
            <% }) %>
          </div>
        </div>
      </aside>
      
      

      <!-- Product Grid -->
      <main class="flex-1 p-6">
        <section class="py-12">
          <div class="container mx-auto px-6">
            <div id="result" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
              <% games.forEach(game => { %>
                <div class="text-center">
                  <!-- Game Card -->
                  <a href="/gamedetail/<%= game._id %>" class="block hover:scale-[1.03] transition duration-300 overflow-hidden">
                    <div class="rounded-2xl overflow-hidden">
                      <img src="<%= game.media.coverImage %>" alt="<%= game.title %>" class="w-full h-auto object-contain">
                    </div>
                  </a>
            
                  <!-- Game Title -->
                  <h3 class="mt-2 text-sm font-semibold text-gray-900"><%= game.title %></h3>
            
                  <!-- Game Type -->
                  <% if (game.type === 'trial') { %>
                    <p class="text-xs text-red-500 font-medium mt-1">üõ°Ô∏è Game Trial</p>
                  <% } else { %>
                    <p class="text-xs text-gray-400 mt-1">Demo Tag</p>
                  <% } %>
            
                  <!-- Pricing -->
                  <div class="mt-1">
                    <% if (game.discountPrice) { %>
                      <span class="text-sm text-red-600 font-semibold">Rs <%= game.discountPrice %></span>
                      <span class="text-xs text-gray-400 line-through ml-1">Rs <%= game.price %></span>
                    <% } else if (game.price === 0) { %>
                      <span class="text-sm text-green-600 font-semibold">Free</span>
                    <% } else { %>
                      <span class="text-sm text-gray-800 font-semibold">Rs <%= game.price %></span>
                    <% } %>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        </section>
      </main>
      
    </div>
    <!-- Footer -->
    <footer class="bg-gray-900 text-gray-300 mt-12">
      <div class="max-w-7xl mx-auto px-6 py-10 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-8">
        
        <!-- Logo & About -->
        <div>
          <h2 class="text-xl font-bold text-white mb-2">üéÆ GameZone</h2>
          <p class="text-sm">Your ultimate destination for the best console games. Explore, play, and level up your experience.</p>
        </div>

        <!-- Quick Links -->
        <div>
          <h3 class="text-lg font-semibold text-white mb-3">Quick Links</h3>
          <ul class="space-y-2 text-sm">
            <li><a href="#" class="hover:text-white">Home</a></li>
            <li><a href="#" class="hover:text-white">Cart</a></li>
            <li><a href="#" class="hover:text-white">Profile</a></li>
            <li><a href="#" class="hover:text-white">Support</a></li>
          </ul>
        </div>

        <!-- Categories -->
        
        <div>
          <h3 class="text-lg font-semibold text-white mb-3">Categories</h3>
          <ul class="space-y-2 text-sm">
            <li><a href="#" class="hover:text-white">Action</a></li>
            <li><a href="#" class="hover:text-white">RPG</a></li>
            <li><a href="#" class="hover:text-white">Shooter</a></li>
            <li><a href="#" class="hover:text-white">Adventure</a></li>
          </ul>
        </div>

        <!-- Newsletter -->
        <div>
          <h3 class="text-lg font-semibold text-white mb-3">Stay Updated</h3>
          <p class="text-sm mb-3">Subscribe to get latest updates and offers.</p>
          <form class="flex flex-col sm:flex-row sm:items-center gap-2">
            <input type="email" placeholder="Enter your email" class="w-full px-3 py-2 rounded-md bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
            <button class="bg-indigo-600 hover:bg-indigo-500 text-white text-sm px-4 py-2 rounded-md">Subscribe</button>
          </form>
        </div>
      </div>

      <div class="border-t border-gray-700 text-center text-sm py-4 mt-6">
        ¬© <%= new Date().getFullYear() %> GameZone. All rights reserved.
      </div>
    </footer>
  </div>

  <script>
    // Page Loading Effect
    document.addEventListener('DOMContentLoaded', () => {
      const loadingOverlay = document.getElementById('loadingOverlay');
      const mainContent = document.getElementById('mainContent');
      
      // Simulate loading time (you can remove this setTimeout in production)
      setTimeout(() => {
        // Hide loading overlay
        loadingOverlay.classList.add('hidden');
        // Show main content
        mainContent.classList.add('loaded');
      }, 2000); // 2 seconds loading time
    });

    // Track image loading
    window.addEventListener('load', () => {
      const images = document.querySelectorAll('img');
      let loadedImages = 0;
      const totalImages = images.length;
      
      function imageLoaded() {
        loadedImages++;
        if (loadedImages === totalImages) {
          // All images are loaded
          const loadingOverlay = document.getElementById('loadingOverlay');
          const mainContent = document.getElementById('mainContent');
          
          loadingOverlay.classList.add('hidden');
          mainContent.classList.add('loaded');
        }
      }

      // Check each image
      images.forEach(img => {
        if (img.complete) {
          imageLoaded();
        } else {
          img.addEventListener('load', imageLoaded);
          img.addEventListener('error', imageLoaded); 
        }
      });
    });

   
    document.addEventListener('DOMContentLoaded', () => {
  const priceRange = document.getElementById('price-range');
  const priceLabel = document.getElementById('price-label');
  const gamesContainer = document.querySelector('.grid');

  const fetchFilteredGames = async () => {
    const selectedGenres = Array.from(document.querySelectorAll('.genre-checkbox:checked')).map(cb => cb.value);
    const selectedCompanies = Array.from(document.querySelectorAll('.company-checkbox:checked')).map(cb => cb.value);
    const maxPrice = priceRange.value;

    try {
      const response = await fetch('/filter-games', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ genres: selectedGenres, companies: selectedCompanies, maxPrice })
      });

      const data = await response.json();
      gamesContainer.innerHTML = '';

      if (data.games.length > 0) {
        data.games.forEach(game => {
          const gameCard = `
            <div class="text-center">
              <a href="/gamedetail/${game._id}" class="block hover:scale-[1.03] transition duration-300 overflow-hidden">
                <div class="rounded-2xl overflow-hidden">
                  <img src="${game.media.coverImage}" alt="${game.title}" class="w-full h-auto object-contain">
                </div>
              </a>
              <h3 class="mt-2 text-sm font-semibold text-gray-900">${game.title}</h3>
              ${game.type === 'trial'
                ? '<p class="text-xs text-red-500 font-medium mt-1">üõ°Ô∏è Game Trial</p>'
                : '<p class="text-xs text-gray-400 mt-1">Demo Tag</p>'
              }
              <div class="mt-1">
                ${
                  game.discountPrice
                    ? `<span class="text-sm text-red-600 font-semibold">Rs ${game.discountPrice}</span>
                       <span class="text-xs text-gray-400 line-through ml-1">Rs ${game.price}</span>`
                    : game.price === 0
                    ? `<span class="text-sm text-green-600 font-semibold">Free</span>`
                    : `<span class="text-sm text-gray-800 font-semibold">Rs ${game.price}</span>`
                }
              </div>
            </div>
          `;
          gamesContainer.innerHTML += gameCard;
        });
      } else {
        gamesContainer.innerHTML = '<p class="text-gray-600 col-span-full text-center">No games found matching your filters.</p>';
      }
    } catch (error) {
      console.error('Error fetching filtered games:', error);
    }
  };

  // Price range change
  priceRange.addEventListener('input', () => {
    priceLabel.textContent = `Up to ‚Çπ${priceRange.value}`;
    fetchFilteredGames();
  });

  // Delegate genre/company checkbox change
  document.querySelector('#sidebar').addEventListener('change', (e) => {
    if (e.target.classList.contains('genre-checkbox') || e.target.classList.contains('company-checkbox')) {
      fetchFilteredGames();
    }
  });
});


    
    // Mobile Menu Functionality
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    let isMenuOpen = false;

    mobileMenuBtn.addEventListener('click', () => {
        isMenuOpen = !isMenuOpen;
        mobileMenu.classList.toggle('hidden');
        mobileMenuBtn.innerHTML = isMenuOpen ? 
            '<i class="fas fa-times text-2xl"></i>' : 
            '<i class="fas fa-bars text-2xl"></i>';
    });

    // Close mobile menu when clicking outside
    document.addEventListener('click', (e) => {
        if (isMenuOpen && !mobileMenu.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
            mobileMenu.classList.add('hidden');
            mobileMenuBtn.innerHTML = '<i class="fas fa-bars text-2xl"></i>';
            isMenuOpen = false;
        }
    });

    // Close mobile menu on window resize
    window.addEventListener('resize', () => {
        if (window.innerWidth >= 768 && isMenuOpen) {
            mobileMenu.classList.add('hidden');
            mobileMenuBtn.innerHTML = '<i class="fas fa-bars text-2xl"></i>';
            isMenuOpen = false;
        }
    });


    //search functionality

     let debounceTimer;

     async function searchGames(query){
      try{        
        console.log('searching games...')
        const response = await fetch(`/allsearch?query=${query}`);
        const data  = await response.json();
        const resultsContainer = document.getElementById('result');
        resultsContainer.innerHTML = '';
        if(data.length >0){
          data.forEach(game=>{

            const gameCard = `
                <div class="text-center">
                  <a href="/gamedetail/${game._id}" class="block hover:scale-[1.03] transition duration-300 overflow-hidden">
                    <div class="rounded-2xl overflow-hidden">
                      <img src="${game.media.coverImage}" alt="${game.title}" class="w-full h-auto object-contain">
                    </div>
                  </a>
                  <h3 class="mt-2 text-sm font-semibold text-gray-900">${game.title}</h3>
                  ${game.type === 'trial'
                    ? '<p class="text-xs text-red-500 font-medium mt-1">üõ°Ô∏è Game Trial</p>'
                    : '<p class="text-xs text-gray-400 mt-1">Demo Tag</p>'
                  }
                  <div class="mt-1">
                    ${
                      game.discountPrice
                        ? `<span class="text-sm text-red-600 font-semibold">Rs ${game.discountPrice}</span>
                           <span class="text-xs text-gray-400 line-through ml-1">Rs ${game.price}</span>`
                        : game.price === 0
                        ? `<span class="text-sm text-green-600 font-semibold">Free</span>`
                        : `<span class="text-sm text-gray-800 font-semibold">Rs ${game.price}</span>`
                    }
                  </div>
                </div>
              `;

              resultsContainer.insertAdjacentHTML('beforeend', gameCard);


          })
        }else{
          resultsContainer.innerHTML = '<p class="text-gray-600 col-span-full text-center">Game Not Found .</p>';
        }
      }catch(error){
        console.error('Error fetching search results:', error);
        
      }
     }

     // debounce funtionn

     document.getElementById('searchInput').addEventListener('input', (e) => {
    const query = e.target.value.trim();

    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
        
            searchGames(query);
      
    }, 300); // 300ms debounce delay
});



// Company filtering



  </script>

</body>
</html>
