<script >
    const openBtn = document.getElementById('openModalBtn');
    const closeBtn = document.getElementById('closeModalBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const modal = document.getElementById('modalOverlay');
  
    openBtn.onclick = () => modal.classList.remove('hidden');
    closeBtn.onclick = () => modal.classList.add('hidden');
    cancelBtn.onclick = () => modal.classList.add('hidden');








    document.querySelectorAll('.edit-offer-btn').forEach(btn => {
  btn.addEventListener('click', function () {
    // Set all fields
    document.getElementById('editOfferId').value = this.dataset.offerId || '';
    document.getElementById('editOfferName').value = this.dataset.offerName || '';
    document.getElementById('editOfferType').value = this.dataset.offerType || '';
    document.getElementById('editDiscountPercentage').value = this.dataset.discount || '';
    document.getElementById('editStartDate').value = this.dataset.start || '';
    document.getElementById('editEndDate').value = this.dataset.end || '';

    // Show/hide and enable/disable selects based on offerType
    if (this.dataset.offerType === 'product') {
      document.getElementById('editProductSelectDiv').style.display = '';
      document.getElementById('editCategorySelectDiv').style.display = 'none';
      document.getElementById('editProductSelect').disabled = false;
      document.getElementById('editCategorySelect').disabled = true;
      document.getElementById('editProductSelect').value = this.dataset.product || '';
    } else if (this.dataset.offerType === 'category') {
      document.getElementById('editProductSelectDiv').style.display = 'none';
      document.getElementById('editCategorySelectDiv').style.display = '';
      document.getElementById('editProductSelect').disabled = true;
      document.getElementById('editCategorySelect').disabled = false;
      document.getElementById('editCategorySelect').value = this.dataset.category || '';
    } else {
      document.getElementById('editProductSelectDiv').style.display = 'none';
      document.getElementById('editCategorySelectDiv').style.display = 'none';
      document.getElementById('editProductSelect').disabled = true;
      document.getElementById('editCategorySelect').disabled = true;
    }

    document.getElementById('editModalOverlay').classList.remove('hidden');
  });
});

document.getElementById('editCloseModalBtn').onclick = () => {
  document.getElementById('editModalOverlay').classList.add('hidden');
};
document.getElementById('editCancelBtn').onclick = () => {
  document.getElementById('editModalOverlay').classList.add('hidden');
};











const offerTableBody = document.querySelector('tbody');
const searchInput = document.getElementById('offerSearchInput');
const clearBtn = document.getElementById('clearSearchBtn');
const searchForm = document.getElementById('offerSearchForm');

function renderOffers(offers) {
  offerTableBody.innerHTML = '';
  if (!offers.length) {
    offerTableBody.innerHTML = `
      <tr>
        <td colspan="7" class="px-6 py-4 text-center text-gray-500">
          No offers found
        </td>
      </tr>
    `;
    return;
  }
  offers.forEach(offer => {
    // Status logic
    const now = new Date();
    const start = new Date(offer.startDate);
    const end = new Date(offer.endDate);
    let status = '';
    let statusClass = '';
    if (!offer.isActive) {
      status = 'Inactive';
      statusClass = 'bg-red-100 text-red-600';
    } else if (now < start) {
      status = 'Scheduled';
      statusClass = 'bg-yellow-100 text-yellow-600';
    } else if (now > end) {
      status = 'Expired';
      statusClass = 'bg-gray-100 text-gray-600';
    } else {
      status = 'Active';
      statusClass = 'bg-green-100 text-green-600';
    }

    offerTableBody.innerHTML += `
      <tr class="hover:bg-gray-50">
        <td class="px-6 py-4">${offer.offerType ? (offer.offerType.charAt(0).toUpperCase() + offer.offerType.slice(1)) : 'N/A'}</td>
        <td class="px-6 py-4 font-medium">${offer.offerName}</td>
        <td class="px-6 py-4">${offer.discountPercentage}%</td>
        <td class="px-6 py-4">${offer.startDate ? new Date(offer.startDate).toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' }) : '-'}</td>
        <td class="px-6 py-4">${offer.endDate ? new Date(offer.endDate).toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' }) : '-'}</td>
        <td class="px-6 py-4">
          <span class="status-badge ${statusClass} text-xs font-semibold px-3 py-1 rounded-full">${status}</span>
        </td>
        <td class="px-6 py-4 flex items-center gap-4">
          <button title="Edit"
            data-offer-id="${offer._id}"
            data-offer-name="${offer.offerName}"
            data-offer-type="${offer.offerType}"
            data-discount="${offer.discountPercentage}"
            data-start="${offer.startDate ? offer.startDate.slice(0,10) : ''}"
            data-end="${offer.endDate ? offer.endDate.slice(0,10) : ''}"
            data-product="${offer.offerType === 'product' ? offer.items[0] : ''}"
            data-category="${offer.offerType === 'category' ? offer.items[0] : ''}"
            class="edit-offer-btn text-blue-600 hover:text-blue-800 transition-colors duration-200">
            <i class="fas fa-pen"></i>
          </button>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox"
              class="sr-only peer offer-status-toggle"
              data-offer-id="${offer._id}"
              ${offer.isActive ? 'checked' : ''}>
            <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-400 rounded-full peer peer-checked:bg-green-500 transition-all duration-300"></div>
            <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform duration-300 transform peer-checked:translate-x-5"></div>
          </label>
        </td>
      </tr>
    `;
  });
}

// Fetch offers from backend
async function fetchOffers(search = '') {
  const res = await fetch(`/admin/offers/api?search=${encodeURIComponent(search)}`);
  const data = await res.json();
  renderOffers(data.offers);
}

// Handle search submit
searchForm.addEventListener('submit', function(e) {
  e.preventDefault();
  fetchOffers(searchInput.value.trim());
  clearBtn.style.display = searchInput.value ? 'block' : 'none';
});

// Handle clear button
clearBtn.addEventListener('click', function () {
  searchInput.value = '';
  fetchOffers('');
  clearBtn.style.display = 'none';
});

// Show/hide clear button as user types
searchInput.addEventListener('input', function () {
  clearBtn.style.display = this.value ? 'block' : 'none';
});

// Initial load (show all offers)
fetchOffers('');

  </script>











/// 


const openBtn = document.getElementById('openModalBtn');
    const closeBtn = document.getElementById('closeModalBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const modal = document.getElementById('modalOverlay');
  
    openBtn.onclick = () => modal.classList.remove('hidden');
    closeBtn.onclick = () => modal.classList.add('hidden');
    cancelBtn.onclick = () => modal.classList.add('hidden');
    document.querySelectorAll('.edit-offer-btn').forEach(btn => {
  btn.addEventListener('click', function () {
    // Set all fields
    document.getElementById('editOfferId').value = this.dataset.offerId || '';
    document.getElementById('editOfferName').value = this.dataset.offerName || '';
    document.getElementById('editOfferType').value = this.dataset.offerType || '';
    document.getElementById('editDiscountPercentage').value = this.dataset.discount || '';
    document.getElementById('editStartDate').value = this.dataset.start || '';
    document.getElementById('editEndDate').value = this.dataset.end || '';

    // Show/hide and enable/disable selects based on offerType
    if (this.dataset.offerType === 'product') {
      document.getElementById('editProductSelectDiv').style.display = '';
      document.getElementById('editCategorySelectDiv').style.display = 'none';
      document.getElementById('editProductSelect').disabled = false;
      document.getElementById('editCategorySelect').disabled = true;
      document.getElementById('editProductSelect').value = this.dataset.product || '';
    } else if (this.dataset.offerType === 'category') {
      document.getElementById('editProductSelectDiv').style.display = 'none';
      document.getElementById('editCategorySelectDiv').style.display = '';
      document.getElementById('editProductSelect').disabled = true;
      document.getElementById('editCategorySelect').disabled = false;
      document.getElementById('editCategorySelect').value = this.dataset.category || '';
    } else {
      document.getElementById('editProductSelectDiv').style.display = 'none';
      document.getElementById('editCategorySelectDiv').style.display = 'none';
      document.getElementById('editProductSelect').disabled = true;
      document.getElementById('editCategorySelect').disabled = true;
    }

    document.getElementById('editModalOverlay').classList.remove('hidden');
  });
});

document.getElementById('editCloseModalBtn').onclick = () => {
  document.getElementById('editModalOverlay').classList.add('hidden');
};
document.getElementById('editCancelBtn').onclick = () => {
  document.getElementById('editModalOverlay').classList.add('hidden');
};

document.addEventListener('DOMContentLoaded', () => {


  const offerTableBody = document.querySelector('tbody');
  const searchInput = document.getElementById('offerSearchInput');
  const clearBtn = document.getElementById('clearSearchBtn');
  const searchForm = document.getElementById('offerSearchForm');
  const paginationDiv = document.getElementById('offerPagination');
  const limit = 5;

  // Show/hide clear button as user types
  searchInput.addEventListener('input', function () {
    clearBtn.style.display = this.value ? 'block' : 'none';
  });
  if (searchInput.value) clearBtn.style.display = 'block';

  // Render offers table
  function renderOffers(offers) {
    offerTableBody.innerHTML = '';
    if (!offers.length) {
      offerTableBody.innerHTML = `
        <tr>
          <td colspan="7" class="px-6 py-4 text-center text-gray-500">
            No offers found
          </td>
        </tr>
      `;
      return;
    }
    offers.forEach(offer => {
      const now = new Date();
      const start = new Date(offer.startDate);
      const end = new Date(offer.endDate);
      let status = '';
      let statusClass = '';
      if (!offer.isActive) {
        status = 'Inactive';
        statusClass = 'bg-red-100 text-red-600';
      } else if (now < start) {
        status = 'Scheduled';
        statusClass = 'bg-yellow-100 text-yellow-600';
      } else if (now > end) {
        status = 'Expired';
        statusClass = 'bg-gray-100 text-gray-600';
      } else {
        status = 'Active';
        statusClass = 'bg-green-100 text-green-600';
      }

      offerTableBody.innerHTML += `
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4">${offer.offerType ? (offer.offerType.charAt(0).toUpperCase() + offer.offerType.slice(1)) : 'N/A'}</td>
          <td class="px-6 py-4 font-medium">${offer.offerName}</td>
          <td class="px-6 py-4">${offer.discountPercentage}%</td>
          <td class="px-6 py-4">${offer.startDate ? new Date(offer.startDate).toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' }) : '-'}</td>
          <td class="px-6 py-4">${offer.endDate ? new Date(offer.endDate).toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' }) : '-'}</td>
          <td class="px-6 py-4">
            <span class="status-badge ${statusClass} text-xs font-semibold px-3 py-1 rounded-full">${status}</span>
          </td>
          <td class="px-6 py-4 flex items-center gap-4">
            <button title="Edit"
              data-offer-id="${offer._id}"
              data-offer-name="${offer.offerName}"
              data-offer-type="${offer.offerType}"
              data-discount="${offer.discountPercentage}"
              data-start="${offer.startDate ? offer.startDate.slice(0,10) : ''}"
              data-end="${offer.endDate ? offer.endDate.slice(0,10) : ''}"
              data-product="${offer.offerType === 'product' ? offer.items[0] : ''}"
              data-category="${offer.offerType === 'category' ? offer.items[0] : ''}"
              class="edit-offer-btn text-blue-600 hover:text-blue-800 transition-colors duration-200">
              <i class="fas fa-pen"></i>
            </button>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox"
                class="sr-only peer offer-status-toggle"
                data-offer-id="${offer._id}"
                ${offer.isActive ? 'checked' : ''}>
              <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-400 rounded-full peer peer-checked:bg-green-500 transition-all duration-300"></div>
              <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform duration-300 transform peer-checked:translate-x-5"></div>
            </label>
          </td>
        </tr>
      `;
    });
    attachOfferToggleListeners();
    attachEditOfferListeners()
  }

  // Render pagination
  function renderPagination(totalPages, currentPage, search) {
    let html = '';
    if (totalPages <= 1) {
      paginationDiv.innerHTML = '';
      return;
    }
    if (currentPage > 1) {
      html += `<button class="px-3 py-1 border rounded bg-white hover:bg-gray-100 text-gray-700" data-page="${currentPage - 1}">Previous</button>`;
    }
    for (let i = 1; i <= totalPages; i++) {
      html += `<button class="px-3 py-1 border rounded ${i === currentPage ? 'bg-blue-500 text-white' : 'bg-white hover:bg-gray-100 text-gray-700'}" data-page="${i}">${i}</button>`;
    }
    if (currentPage < totalPages) {
      html += `<button class="px-3 py-1 border rounded bg-white hover:bg-gray-100 text-gray-700" data-page="${currentPage + 1}">Next</button>`;
    }
    paginationDiv.innerHTML = html;
    paginationDiv.querySelectorAll('button[data-page]').forEach(btn => {
      btn.onclick = () => {
        fetchOffers(search, parseInt(btn.getAttribute('data-page')));
      };
    });
  }

  function attachEditOfferListeners() {
  document.querySelectorAll('.edit-offer-btn').forEach(btn => {
    btn.onclick = function () {
      document.getElementById('editOfferId').value = this.dataset.offerId || '';
      document.getElementById('editOfferName').value = this.dataset.offerName || '';
      document.getElementById('editOfferType').value = this.dataset.offerType || '';
      document.getElementById('editDiscountPercentage').value = this.dataset.discount || '';
      document.getElementById('editStartDate').value = this.dataset.start || '';
      document.getElementById('editEndDate').value = this.dataset.end || '';

      if (this.dataset.offerType === 'product') {
        document.getElementById('editProductSelectDiv').style.display = '';
        document.getElementById('editCategorySelectDiv').style.display = 'none';
        document.getElementById('editProductSelect').disabled = false;
        document.getElementById('editCategorySelect').disabled = true;
        document.getElementById('editProductSelect').value = this.dataset.product || '';
      } else if (this.dataset.offerType === 'category') {
        document.getElementById('editProductSelectDiv').style.display = 'none';
        document.getElementById('editCategorySelectDiv').style.display = '';
        document.getElementById('editProductSelect').disabled = true;
        document.getElementById('editCategorySelect').disabled = false;
        document.getElementById('editCategorySelect').value = this.dataset.category || '';
      } else {
        document.getElementById('editProductSelectDiv').style.display = 'none';
        document.getElementById('editCategorySelectDiv').style.display = 'none';
        document.getElementById('editProductSelect').disabled = true;
        document.getElementById('editCategorySelect').disabled = true;
      }

      document.getElementById('editModalOverlay').classList.remove('hidden');
    };
  });
}

  // Fetch offers from backend
  async function fetchOffers(search = '', page = 1) {
    const res = await fetch(`/admin/offers/api?search=${encodeURIComponent(search)}&page=${page}&limit=${limit}`);
    const data = await res.json();
    renderOffers(data.offers);
    renderPagination(data.totalPages, data.currentPage, search);
  }

  // Handle search submit
  searchForm.addEventListener('submit', function(e) {
    e.preventDefault();
    fetchOffers(searchInput.value.trim(), 1);
    clearBtn.style.display = searchInput.value ? 'block' : 'none';
  });

  // Handle clear button
  clearBtn.addEventListener('click', function () {
    searchInput.value = '';
    fetchOffers('', 1);
    clearBtn.style.display = 'none';
  });

  // Initial load (show all offers)
  fetchOffers('', 1);

  // Attach offer toggle listeners
  function attachOfferToggleListeners() {
    document.querySelectorAll('.offer-status-toggle').forEach(toggle => {
      toggle.onchange = null;
      toggle.addEventListener('change', async function() {
        const offerId = this.dataset.offerId;
        const newState = this.checked;
        try {
          const response = await fetch(`/admin/offers/toggle/${offerId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ isActive: newState })
          });
          const data = await response.json();
          if (response.ok) {
            // Update status badge in the same row
            const row = this.closest('tr');
            const statusBadge = row.querySelector('.status-badge');
            const startDate = new Date(row.children[3].textContent);
            const endDate = new Date(row.children[4].textContent);
            const now = new Date();
            let status, statusClass;
            if (!newState) {
              status = 'Inactive';
              statusClass = 'bg-red-100 text-red-600';
            } else if (now < startDate) {
              status = 'Scheduled';
              statusClass = 'bg-yellow-100 text-yellow-600';
            } else if (now > endDate) {
              status = 'Expired';
              statusClass = 'bg-gray-100 text-gray-600';
            } else {
              status = 'Active';
              statusClass = 'bg-green-100 text-green-600';
            }
            statusBadge.className = `status-badge ${statusClass} text-xs font-semibold px-3 py-1 rounded-full`;
            statusBadge.textContent = status;
            if (typeof showToast === 'function') showToast('Success', data.message, 'success');
          } else {
            this.checked = !newState;
            if (typeof showToast === 'function') showToast('Error', data.message || 'Failed to update status', 'error');
          }
        } catch (error) {
          this.checked = !newState;
          if (typeof showToast === 'function') showToast('Error', 'Failed to update offer status', 'error');
        }
      });
    });
  }
});














<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order Success</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: #f9fafb;
    }

    .fade-in {
      opacity: 0;
      transform: scale(0.9);
      transition: all 0.8s ease-in-out;
    }

    .fade-in.show {
      opacity: 1;
      transform: scale(1);
    }

    @keyframes bounce {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    .bounce {
      animation: bounce 0.6s ease;
    }
    
  </style>
      <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="flex items-center justify-center min-h-screen px-4">
   <%- include("partials/navbar", { page: page }) %>
  <div id="orderCard" class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full text-center fade-in">

    <!-- Check Icon -->
    <div id="checkIcon" class="mx-auto w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-4xl mb-6 scale-0">
      âœ“
    </div>

    <!-- Message -->
    <h1 class="text-2xl font-bold text-gray-800 mb-2">Thank You for Your Order!</h1>
    <p class="text-gray-600 mb-1">Your order has been successfully placed.</p>
    <p class="text-sm text-gray-500 mb-6">Order ID: <span class="font-semibold">#ORD-00033</span></p>

    <!-- Illustration -->
    <div class="flex justify-center mb-6">
      <img src="https://cdn-icons-png.flaticon.com/512/11571/11571315.png" alt="Order Done" class="w-24 h-24 object-contain opacity-0 transition-opacity duration-700" id="orderImage" />
    </div>

    <!-- Buttons -->
    <div class="flex flex-col sm:flex-row gap-4 justify-center">
      <a href="/orderDetails" class="border border-gray-400 px-4 py-2 rounded-md hover:bg-gray-100 transition-all">View Order Details</a>
      <a href="#" class="bg-black text-white px-4 py-2 rounded-md hover:bg-gray-800 transition-all">Continue Shopping</a>
    </div>
  </div>

  <!-- Confetti canvas -->
  <canvas id="confettiCanvas" class="fixed top-0 left-0 w-full h-full pointer-events-none z-50"></canvas>

  <script>
    // Fade + bounce
    window.addEventListener('DOMContentLoaded', () => {
      const card = document.getElementById('orderCard');
      const checkIcon = document.getElementById('checkIcon');
      const image = document.getElementById('orderImage');

      setTimeout(() => {
        card.classList.add('show');
        checkIcon.classList.add('scale-100', 'bounce');
        image.classList.add('opacity-100');
        fireConfetti();
      }, 400);
    });

    // Confetti Effect
    function fireConfetti() {
      const canvas = document.getElementById('confettiCanvas');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const confetti = Array.from({ length: 100 }, () => ({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height - canvas.height,
        r: Math.random() * 6 + 4,
        d: Math.random() * 40 + 10,
        color: `hsl(${Math.random() * 360}, 70%, 60%)`,
        tilt: Math.random() * 10 - 10
      }));

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        confetti.forEach(c => {
          ctx.beginPath();
          ctx.fillStyle = c.color;
          ctx.arc(c.x, c.y, c.r, 0, Math.PI * 2, false);
          ctx.fill();
        });
        update();
      }

      function update() {
        confetti.forEach(c => {
          c.y += Math.cos(c.d / 10) + 1 + c.r / 5;
          c.x += Math.sin(0.01) * 2;
          if (c.y > canvas.height) {
            c.y = -10;
            c.x = Math.random() * canvas.width;
          }
        });
      }

      function loop() {
        draw();
        requestAnimationFrame(loop);
      }

      loop();
    }
  </script>
  
   <script src="/js/cart.js"></script>
   <%- include('partials/footer') %>
</body>


</html>




































import Order from "../models/orderModel.js";
import User from "../models/userModel.js";

export const getDashBoardPage = async(req,res)=>{

 try{

  // const totalRevenue = await Order.aggregate([
  //   {
  //     $match: {
  //       // paymentStatus: 'paid',
  //       items: {
  //         $elemMatch: { status: 'Delivered' }
  //       },
  //       'items.status':{$nin: ['Cancelled','Returned']}
  //     }
  //   },
  //   {
  //     $group: {
  //       _id: null,
  //       sum: { $sum: "$grandTotal" }
  //     }
  //   }
  // ]);

  const totalRevenue = await Order.aggregate([
    { $unwind: "$items" },
    { $match: { "items.status": "Delivered" } },
    { $group: { _id: null, sum: { $sum: { $multiply: ["$items.price", "$items.quantity"] } } } }
  ]);
  

  const totalOrders = await Order.countDocuments({
    items: { $elemMatch: { status: 'Delivered' } }
  });
      const totalCustomers = await User.countDocuments();
      const pendingDelivery = await Order.countDocuments();

      res.render('admin/dashboard', {
        totalRevenue: totalRevenue[0]?.sum || 0,
        totalOrders,
        totalCustomers,
        pendingDelivery,
     
      });
 }catch(error){
    console.error('Error while fetching admin Dashboard',error);
    res.status(500).render('error',{message: 'server is down please try again later'});
 }

  
}




export const getDashBoardFilter = async (req, res) => {
  try {
    const { filter, from, to } = req.query;
    const now = new Date();
    let match = {};
    let start, end;

    // Only set date range if a filter is provided
    if (filter === 'custom' && from && to) {
      start = new Date(from);
      end = new Date(to);
      end.setHours(23, 59, 59, 999);
      match.createdAt = { $gte: start, $lt: end };
    } else if (filter === 'daily') {
      start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
      match.createdAt = { $gte: start, $lt: end };
    } else if (filter === 'monthly') {
      start = new Date(now.getFullYear(), now.getMonth(), 1);
      end = new Date(now.getFullYear(), now.getMonth() + 1, 1);
      match.createdAt = { $gte: start, $lt: end };
    }
    // else: no filter, do not set match.createdAt (show all data)

    // Total Revenue (exclude Cancelled/Returned)
    const totalRevenue = await Order.aggregate([
      { $match: { ...match } },
      { $unwind: "$items" },
      { $match: { "items.status": "Delivered" } },
      { $group: { _id: null, sum: { $sum: { $multiply: ["$items.price", "$items.quantity"] } } } }
    ]);

    // Total Orders (only Delivered)
    const totalOrders = await Order.countDocuments({
      ...match,
      items: { $elemMatch: { status: 'Delivered' } }
    });

    // Total Customers
    const totalCustomers = await User.countDocuments();

    // Pending Delivery (only Pending)
    const pendingDelivery = await Order.countDocuments({
      ...match,
      items: { $elemMatch: { status: 'Pending' } }
    });

    // --- Dynamic Sales Target Calculation ---
    const revenue = totalRevenue[0]?.sum || 0;
    let monthlyTarget = 0;
    let dailyTarget = 0;

    if (filter === 'custom' && from && to) {
      const startDate = new Date(from);
      const endDate = new Date(to);
      const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
      const months =
        (endDate.getFullYear() - startDate.getFullYear()) * 12 +
        (endDate.getMonth() - startDate.getMonth()) + 1;

      if (
        startDate.getFullYear() === endDate.getFullYear() &&
        startDate.getMonth() === endDate.getMonth()
      ) {
        dailyTarget = Math.round(revenue / days) || 0;
        monthlyTarget = revenue;
      } else {
        monthlyTarget = Math.round(revenue / months) || 0;
        dailyTarget = Math.round(revenue / days) || 0;
      }
    } else if (filter === 'daily') {
      const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
      dailyTarget = revenue;
      monthlyTarget = Math.round(revenue * daysInMonth) || 0;
    } else if (filter === 'monthly') {
      const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
      monthlyTarget = revenue;
      dailyTarget = Math.round(revenue / daysInMonth) || 0;
    } else {
      // Default: all time
      monthlyTarget = Math.round(revenue / 12) || 0;
      dailyTarget = Math.round(revenue / 365) || 0;
    }

    // --- Sales Chart ---
    let salesChart = { labels: [], data: [] };

    if (filter === 'daily') {
      // Hourly sales for today
      for (let h = 0; h < 24; h++) {
        const hourStart = new Date(start);
        hourStart.setHours(h, 0, 0, 0);
        const hourEnd = new Date(start);
        hourEnd.setHours(h + 1, 0, 0, 0);
        const orders = await Order.aggregate([
          { $match: { createdAt: { $gte: hourStart, $lt: hourEnd } } },
          { $unwind: "$items" },
          { $match: { "items.status": "Delivered" } },
          { $group: { _id: null, sum: { $sum: { $multiply: ["$items.price", "$items.quantity"] } } } }
        ]);
        salesChart.labels.push(`${h}:00`);
        salesChart.data.push(orders[0]?.sum || 0);
      }
    } else if (filter === 'custom' && from && to) {
      const startDate = new Date(from);
      const endDate = new Date(to);
      if (
        startDate.getFullYear() === endDate.getFullYear() &&
        startDate.getMonth() === endDate.getMonth()
      ) {
        // Daily sales for custom range within one month
        for (let h = 0; h < 24; h++) {
          const hourStart = new Date(start);
          hourStart.setHours(h, 0, 0, 0);
          const hourEnd = new Date(start);
          hourEnd.setHours(h + 1, 0, 0, 0);
          const orders = await Order.aggregate([
            { $match: { createdAt: { $gte: hourStart, $lt: hourEnd } } },
            { $unwind: "$items" },
            { $match: { "items.status": "Delivered" } },
            { $group: { _id: null, sum: { $sum: { $multiply: ["$items.price", "$items.quantity"] } } } }
          ]);
          salesChart.labels.push(`${h}:00`);
          salesChart.data.push(orders[0]?.sum || 0);
        }
      } else {
        // Month-wise sales for custom range spanning multiple months
        let current = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
        const last = new Date(endDate.getFullYear(), endDate.getMonth() + 1, 1);
        while (current < last) {
          const monthStart = new Date(current);
          const monthEnd = new Date(current.getFullYear(), current.getMonth() + 1, 1);
          const orders = await Order.aggregate([
            { $match: { createdAt: { $gte: monthStart, $lt: monthEnd } } },
            { $unwind: "$items" },
            { $match: { "items.status": "Delivered" } },
            { $group: { _id: null, sum: { $sum: { $multiply: ["$items.price", "$items.quantity"] } } } }
          ]);
          salesChart.labels.push(
            monthStart.toLocaleString('default', { month: 'short', year: 'numeric' })
          );
          salesChart.data.push(orders[0]?.sum || 0);
          current.setMonth(current.getMonth() + 1);
        }
      }
    }  else if (filter === 'monthly') {
      // Month-wise sales for current year
      // for (let m = 0; m < 12; m++) {
      //   const monthStart = new Date(now.getFullYear(), m, 1);
      //   const monthEnd = new Date(now.getFullYear(), m + 1, 1);
      //   const orders = await Order.aggregate([
      //     {
      //       $match: {
      //         paymentStatus: 'paid',
      //         createdAt: { $gte: monthStart, $lt: monthEnd },
      //         $nor: [
      //           { items: { $elemMatch: { status: 'Cancelled' } } },
      //           { items: { $elemMatch: { status: 'Returned' } } }
      //         ]
      //       }
      //     },
      //     { $group: { _id: null, sum: { $sum: "$grandTotal" } } }
      //   ]);
      //   salesChart.labels.push(
      //     monthStart.toLocaleString('default', { month: 'short' })
      //   );
      //   salesChart.data.push(orders[0]?.sum || 0);
      // }
      if (filter === 'monthly') {
        const yearStart = new Date(now.getFullYear(), 0, 1);
        const yearEnd = new Date(now.getFullYear() + 1, 0, 1);
      
        const monthlySales = await Order.aggregate([
          {
            $match: {
              // paymentStatus: 'paid',
              items: {
                $elemMatch: { status: 'Delivered' }
              },
              createdAt: { $gte: yearStart, $lt: yearEnd },
              $nor: [
                { items: { $elemMatch: { status: 'Cancelled' } } },
                { items: { $elemMatch: { status: 'Returned' } } }
              ]
            }
          },
          {
            $group: {
              _id: { $month: "$createdAt" },
              sum: { $sum: "$grandTotal" }
            }
          },
          { $sort: { "_id": 1 } }
        ]);
      
        // Prepare labels and data for all 12 months
        salesChart.labels = [];
        salesChart.data = [];
        for (let m = 1; m <= 12; m++) {
          const found = monthlySales.find(ms => ms._id === m);
          salesChart.labels.push(new Date(now.getFullYear(), m - 1, 1).toLocaleString('default', { month: 'short' }));
          salesChart.data.push(found ? found.sum : 0);
        }
      }
    } else {
      // Default: all time, show year-wise sales for last 5 years
   const currentYear = now.getFullYear();
for (let y = currentYear - 4; y <= currentYear; y++) {
  const yearStart = new Date(y, 0, 1);
  const yearEnd = new Date(y + 1, 0, 1);
  const orders = await Order.aggregate([
    { $match: { createdAt: { $gte: yearStart, $lt: yearEnd } } },
    { $unwind: "$items" },
    { $match: { "items.status": "Delivered" } },
    { $group: { _id: null, sum: { $sum: { $multiply: ["$items.price", "$items.quantity"] } } } }
  ]);
  salesChart.labels.push(`${y}`);
  salesChart.data.push(orders[0]?.sum || 0);
}
    }

    // --- Top Products ---
    const topProducts = await Order.aggregate([
      { $match: { paymentStatus: 'paid', ...match } },
      { $unwind: '$items' },
      { $match: { 'items.status': { $nin: ['Cancelled', 'Returned'] } } },
      {
        $group: {
          _id: '$items.productId',
          totalSold: { $sum: '$items.quantity' }
        }
      },
      {
        $lookup: {
          from: 'games',
          localField: '_id',
          foreignField: '_id',
          as: 'product'
        }
      },
      { $unwind: '$product' },
      {
        $project: {
          title: '$product.title',
          coverImage: '$product.media.coverImage',
          totalSold: 1
        }
      },
      { $sort: { totalSold: -1 } },
      { $limit: 10 }
    ]);

    // --- Top Categories ---
    const topCategories = await Order.aggregate([
      { $match: { paymentStatus: 'paid', ...match } },
      { $unwind: '$items' },
      { $match: { 'items.status': { $nin: ['Cancelled', 'Returned'] } } },
      {
        $lookup: {
          from: 'games',
          localField: 'items.productId',
          foreignField: '_id',
          as: 'game'
        }
      },
      { $unwind: '$game' },
      {
        $group: {
          _id: '$game.category',
          totalSold: { $sum: '$items.quantity' }
        }
      },
      {
        $lookup: {
          from: 'categories',
          localField: '_id',
          foreignField: '_id',
          as: 'category'
        }
      },
      { $unwind: '$category' },
      {
        $project: {
          name: '$category.categoryName',
          totalSold: 1
        }
      },
      { $sort: { totalSold: -1 } },
      { $limit: 10 }
    ]);

    // --- Top Brands ---
    const topBrands = await Order.aggregate([
      { $match: { paymentStatus: 'paid', ...match } },
      { $unwind: '$items' },
      { $match: { 'items.status': { $nin: ['Cancelled', 'Returned'] } } },
      {
        $lookup: {
          from: 'games',
          localField: 'items.productId',
          foreignField: '_id',
          as: 'game'
        }
      },
      { $unwind: '$game' },
      {
        $group: {
          _id: '$game.company',
          totalSold: { $sum: '$items.quantity' }
        }
      },
      {
        $lookup: {
          from: 'gamecompanies',
          localField: '_id',
          foreignField: '_id',
          as: 'brand'
        }
      },
      { $unwind: '$brand' },
      {
        $project: {
          name: '$brand.name',
          totalSold: 1
        }
      },
      { $sort: { totalSold: -1 } },
      { $limit: 10 }
    ]);

    res.json({
      totalRevenue: revenue,
      totalOrders,
      totalCustomers,
      pendingDelivery,
      salesChart,
      monthlyTarget,
      topProducts,
      topCategories,
      topBrands,
      dailyTarget
    });
  } catch (error) {
    console.error('Error while fetching dashboard summary', error);
    res.status(500).json({ error: 'Server error' });
  }
};










// export const getDashBoardFilter = async (req, res) => {
//   try {
//     const { filter, from, to } = req.query;
//     let match = {};
//     const now = new Date();

//     // Default: current year
//     let start = new Date(now.getFullYear(), 0, 1);
//     let end = new Date(now.getFullYear() + 1, 0, 1);

//     // Custom date range
//     if (filter === 'custom' && from && to) {
//       start = new Date(from);
//       end = new Date(to);
//       end.setHours(23, 59, 59, 999);
//     }

//     match.createdAt = { $gte: start, $lt: end };

//     const totalRevenue = await Order.aggregate([
//       { $match: { ...match, paymentStatus: 'paid',
//         $nor: [
//           { items: { $elemMatch: { status: 'Cancelled' } } },
//           { items: { $elemMatch: { status: 'Returned' } } }
//         ]
//       }},
//       { $group: { _id: null, sum: { $sum: "$grandTotal" } } }
//     ]);
//     const totalOrders = await Order.countDocuments({
//       items: { $elemMatch: { status: 'Delivered' } }
//     });
//     const totalCustomers = await User.countDocuments();
//     const pendingDelivery = await Order.countDocuments({ ...match, 'items.status': { $in: ['Pending'] } });

//     // --- Dynamic Sales Target Calculation ---
//     let monthlyTarget = 0;
//     let dailyTarget = 0;
//     const revenue = totalRevenue[0]?.sum || 0;

//     if (filter === 'custom' && from && to) {
//       const startDate = new Date(from);
//       const endDate = new Date(to);
//       // Calculate number of days and months in range
//       const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
//       const months =
//         (endDate.getFullYear() - startDate.getFullYear()) * 12 +
//         (endDate.getMonth() - startDate.getMonth()) + 1;

//       if (
//         startDate.getFullYear() === endDate.getFullYear() &&
//         startDate.getMonth() === endDate.getMonth()
//       ) {
//         // If within one month, show daily target
//         dailyTarget = Math.round(revenue / days) || 0;
//         monthlyTarget = revenue;
//       } else {
//         // If multi-month, show monthly target
//         monthlyTarget = Math.round(revenue / months) || 0;
//         dailyTarget = Math.round(revenue / days) || 0;
//       }
//     } else if (filter === 'daily') {
//       // Current month
//       const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
//       dailyTarget = Math.round(revenue / daysInMonth) || 0;
//       monthlyTarget = revenue;
//     } else {
//       // Default: current year
//       monthlyTarget = Math.round(revenue / 12) || 0;
//       const daysInYear = (new Date(now.getFullYear(), 11, 31) - new Date(now.getFullYear(), 0, 1)) / (1000 * 60 * 60 * 24) + 1;
//       dailyTarget = Math.round(revenue / daysInYear) || 0;
//     }

//     // ... salesChart logic remains unchanged ...

//     let salesChart = { labels: [], data: [] };

//     if (filter === 'daily') {
//       // Daily sales for current month
//       const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
//       for (let d = 1; d <= daysInMonth; d++) {
//         const dayStart = new Date(now.getFullYear(), now.getMonth(), d);
//         const dayEnd = new Date(now.getFullYear(), now.getMonth(), d + 1);
//         const orders = await Order.aggregate([
//           { $match: { paymentStatus: 'paid', createdAt: { $gte: dayStart, $lt: dayEnd },
//             $nor: [
//               { items: { $elemMatch: { status: 'Cancelled' } } },
//               { items: { $elemMatch: { status: 'Returned' } } }
//             ]
//           } },
//           { $group: { _id: null, sum: { $sum: "$grandTotal" } } }
//         ]);
//         salesChart.labels.push(`${d} ${now.toLocaleString('default', { month: 'short' })}`);
//         salesChart.data.push(orders[0]?.sum || 0);
//       }
//     } else if (filter === 'custom' && from && to) {
//       const startDate = new Date(from);
//       const endDate = new Date(to);
//       if (
//         startDate.getFullYear() === endDate.getFullYear() &&
//         startDate.getMonth() === endDate.getMonth()
//       ) {
//         // Daily sales for custom range within one month
//         for (
//           let d = new Date(startDate);
//           d <= endDate;
//           d.setDate(d.getDate() + 1)
//         ) {
//           const dayStart = new Date(d);
//           const dayEnd = new Date(d);
//           dayEnd.setDate(dayEnd.getDate() + 1);
//           const orders = await Order.aggregate([
//             { $match: { paymentStatus: 'paid', createdAt: { $gte: dayStart, $lt: dayEnd },
//               $nor: [
//                 { items: { $elemMatch: { status: 'Cancelled' } } },
//                 { items: { $elemMatch: { status: 'Returned' } } }
//               ]
//             } },
//             { $group: { _id: null, sum: { $sum: "$grandTotal" } } }
//           ]);
//           salesChart.labels.push(
//             `${dayStart.getDate()} ${dayStart.toLocaleString('default', { month: 'short' })}`
//           );
//           salesChart.data.push(orders[0]?.sum || 0);
//         }
//       } else {
//         // Month-wise sales for custom range spanning multiple months
//         let current = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
//         const last = new Date(endDate.getFullYear(), endDate.getMonth() + 1, 1);
//         while (current < last) {
//           const monthStart = new Date(current);
//           const monthEnd = new Date(current.getFullYear(), current.getMonth() + 1, 1);
//           const orders = await Order.aggregate([
//             { $match: { paymentStatus: 'paid', createdAt: { $gte: monthStart, $lt: monthEnd },
//               $nor: [
//                 { items: { $elemMatch: { status: 'Cancelled' } } },
//                 { items: { $elemMatch: { status: 'Returned' } } }
//               ]
//             } },
//             { $group: { _id: null, sum: { $sum: "$grandTotal" } } }
//           ]);
//           salesChart.labels.push(
//             monthStart.toLocaleString('default', { month: 'short', year: 'numeric' })
//           );
//           salesChart.data.push(orders[0]?.sum || 0);
//           current.setMonth(current.getMonth() + 1);
//         }
//       }
//     } else {
//       // Month-wise sales for current year (default)
//       for (let m = 0; m < 12; m++) {
//         const monthStart = new Date(now.getFullYear(), m, 1);
//         const monthEnd = new Date(now.getFullYear(), m + 1, 1);
//         const orders = await Order.aggregate([
//           { $match: { paymentStatus: 'paid', createdAt: { $gte: monthStart, $lt: monthEnd },
//             $nor: [
//               { items: { $elemMatch: { status: 'Cancelled' } } },
//               { items: { $elemMatch: { status: 'Returned' } } }
//             ]
//           } },
//           { $group: { _id: null, sum: { $sum: "$grandTotal" } } }
//         ]);
//         salesChart.labels.push(
//           new Date(now.getFullYear(), m, 1).toLocaleString('default', { month: 'short' })
//         );
//         salesChart.data.push(orders[0]?.sum || 0);
//       }
//     }




//     const topProducts = await Order.aggregate([

//       { $match: { paymentStatus: 'paid' } },

    
//       { $unwind: '$items' },


//       {
//         $match: {
//           'items.status': { $nin: ['Cancelled', 'Returned'] }
//         }
//       },


//       {
//         $group: {
//           _id: '$items.productId',
//           totalSold: { $sum: '$items.quantity' }
//         }
//       },

//       // Join with Game collection
//       {
//         $lookup: {
//           from: 'games',
//           localField: '_id',
//           foreignField: '_id',
//           as: 'product'
//         }
//       },
//       { $unwind: '$product' },

//       {
//         $project: {
//           title: '$product.title',
//           coverImage: '$product.media.coverImage',
//           totalSold: 1
//         }
//       },


//       { $sort: { totalSold: -1 } },
//       { $limit: 10 }
//     ]);


//     const topCategories = await Order.aggregate([
//       { $match: { paymentStatus: 'paid' } },
//       { $unwind: '$items' },
//       { $match: { 'items.status': { $nin: ['Cancelled', 'Returned'] } } },
//       {
//         $lookup: {
//           from: 'games',
//           localField: 'items.productId',
//           foreignField: '_id',
//           as: 'game'
//         }
//       },
//       { $unwind: '$game' },
//       {
//         $group: {
//           _id: '$game.category', // This is likely a string (category name)
//           totalSold: { $sum: '$items.quantity' }
//         }
//       },
//       {
//         $lookup: {
//           from: 'categories',
//           localField: '_id',      // category name
//           foreignField: '_id',   // categories.name
//           as: 'category'
//         }
//       },
//       { $unwind: '$category' },
//       {
//         $project: {
//           name: '$category.categoryName',
//           totalSold: 1
//         }
//       },
//       { $sort: { totalSold: -1 } },
//       { $limit: 10 }
//     ]);


//     const topBrands = await Order.aggregate([
//       // 1. Only paid orders
//       { $match: { paymentStatus: 'paid' } },
    
//       // 2. Unwind items array
//       { $unwind: '$items' },
    
//       // 3. Exclude cancelled and returned items
//       {
//         $match: {
//           'items.status': { $nin: ['Cancelled', 'Returned'] }
//         }
//       },
    
//       // 4. Lookup Game to get company (brand) info
//       {
//         $lookup: {
//           from: 'games',
//           localField: 'items.productId',
//           foreignField: '_id',
//           as: 'game'
//         }
//       },
//       { $unwind: '$game' },
    
//       // 5. Group by company (brand) ID and sum quantities
//       {
//         $group: {
//           _id: '$game.company',
//           totalSold: { $sum: '$items.quantity' }
//         }
//       },
    
//       // 6. Lookup company (brand) details
//       {
//         $lookup: {
//           from: 'gamecompanies', // Make sure your GameCompany collection is named this
//           localField: '_id',
//           foreignField: '_id',
//           as: 'brand'
//         }
//       },
//       { $unwind: '$brand' },
    
//       // 7. Project brand name and totalSold
//       {
//         $project: {
//           name: '$brand.name',
//           totalSold: 1
//         }
//       },
    
//       // 8. Sort and limit
//       { $sort: { totalSold: -1 } },
//       { $limit: 10 }
//     ]);
    

 
    

   

//     res.json({
//       totalRevenue: revenue,
//       totalOrders,
//       totalCustomers,
//       pendingDelivery,
//       salesChart,
//       monthlyTarget,
//       topProducts,
//       topCategories,
//       topBrands,
//       dailyTarget
//     });
//   } catch (error) {
//     console.error('Error while fetching dashboard summary', error);
//     res.status(500).json({ error: 'Server error' });
//   }
// };


